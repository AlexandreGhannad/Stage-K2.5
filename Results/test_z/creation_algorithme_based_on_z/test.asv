%% Cleaning
close all
clear all
clc
%% Load one x and z
i=5;
load("xlist")
load("zlist")
x = xlist(i,:);
z = zlist(i,:);
x(isnan(x)) = [];
z(isnan(z)) = [];
%% Print x and z
figure();
semilogy(z)
hold on
semilogy(x)
%% Test on one part of a graphic
% close all
n = 73;
xt = 1:n;
zt = z(1:n);
lambda = 10^10;

f = @(a) sum(abs(log10(zt) - a(1)*(xt) - a(2)));

x0 = [1 1];
xf = fminsearch(f, x0)

figure()
subplot(211)
plot(zt)
hold on
plot([1 73], xf(1)*[1 73] + xf(2))
subplot(212)
plot(log10(zt))
hold on
plot([1 73], xf(1)*[1 73] + xf(2))


% figure()
% subplot(211)
% plot(xt)
% hold on
% plot(zt)
% subplot(212)
% semilogy(xt)
% hold on
% semilogy(zt)
%% Global test of the idea
rapport = zeros([1, length(x)-1]);
err = zeros([1, length(x)-1]);
xf = zeros([3, length(x)-1]);
rapport(:,1) = NaN;
err(:,1) = NaN;
xf(:,1) = NaN;

for n = 1 : length(x)-1
    coef = find_abc(z, n);
    a = coef(1);
    b = coef(2);
    c = coef(3);
    y = broken_lines(a,b,c,n,length(z));
    rapport(n) = a/b;
    err(n) = sum(abs(log10(z) - y));
    xf(:,n) = coef;
end

figure()
subplot(221)
plot(rapport)
subplot(223)
semilogy(-rapport)

subplot(222)
plot(err)
subplot(224)
semilogy(err)

n = 73;
coef = xf(:,n);
a = coef(1);
b = coef(2);
c = coef(3);
y = broken_lines(a,b,c,n,length(z));

figure()
plot(log10(z))
hold on
plot(y)






























